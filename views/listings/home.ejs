<% layout("/layouts/boilerplate") %>

<div class="container">
  <div class="main-content">
    <!-- Featured Plant -->
    <div class="featured-section">
      <img src="<%= allListings[0].image.url %>" class="plant-image" alt="<%= allListings[0].title %>" />
      <div class="plant-featured-info">
        <div>
          <h3 class="plant-featured-name"><%= allListings[0].title %></h3>
          <p class="plant-featured-desc"><%= allListings[0].description %></p>
        </div>
        <a href="/listings/<%= allListings[0]._id %>" class="show-more">Explore <i class="fas fa-arrow-right"></i></a>
      </div>
    </div>

    <!-- Right content -->
    <div class="right-content">
      <div class="hero-text">
        <p class="hero-tagline">Go green.</p>
        <h1 class="hero-heading">The world of plants</h1>
        <p class="hero-description">Discover everything you need to know about your plants.</p>
      </div>

      <div class="top-plants-section">
        <div class="top-plants-header">
          <h2 class="top-plants-heading">Top 5 of the week</h2>
          <div class="carousel-controls">
            <button class="carousel-control" id="pauseBtn" title="Pause rotation">
              <i class="fas fa-pause"></i>
            </button>
            <button class="carousel-control" id="playBtn" title="Play rotation" style="display: none;">
              <i class="fas fa-play"></i>
            </button>
          </div>
        </div>

        <div class="plants-grid">
          <% allListings.slice(1, 5).forEach((plant, index) => { %>
            <div class="plant-small" data-index="<%= index %>" data-desc="<%= plant.description %>">
              <img src="<%= plant.image.url %>" class="plant-image" alt="<%= plant.title %>" />
              <div class="plant-small-info">
                <h3 class="plant-small-name"><%= plant.title %></h3>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const smallPlants = document.querySelectorAll('.plant-small');
    const featuredPlant = document.querySelector('.featured-section');
    const featuredImg = featuredPlant.querySelector('img');
    const featuredName = featuredPlant.querySelector('.plant-featured-name');
    const featuredDesc = featuredPlant.querySelector('.plant-featured-desc');
    const pauseBtn = document.getElementById('pauseBtn');
    const playBtn = document.getElementById('playBtn');

    let autoRotationInterval;
    let isAutoRotating = true;

    function rotatePlants() {
      const featuredData = {
        name: featuredName.textContent,
        description: featuredDesc.textContent,
        image: featuredImg.src
      };

      const firstSmall = smallPlants[0];
      const firstName = firstSmall.querySelector('.plant-small-name').textContent;
      const firstDesc = firstSmall.dataset.desc;
      const firstImg = firstSmall.querySelector('img').src;

      // Update featured
      featuredName.textContent = firstName;
      featuredDesc.textContent = firstDesc;
      featuredImg.src = firstImg;

      // Shift small plants
      for (let i = 0; i < smallPlants.length - 1; i++) {
        const current = smallPlants[i];
        const next = smallPlants[i + 1];

        current.querySelector('.plant-small-name').textContent = next.querySelector('.plant-small-name').textContent;
        current.querySelector('img').src = next.querySelector('img').src;
        current.dataset.desc = next.dataset.desc;
      }

      // Put old featured into last small slot
      const last = smallPlants[smallPlants.length - 1];
      last.querySelector('.plant-small-name').textContent = featuredData.name;
      last.querySelector('img').src = featuredData.image;
      last.dataset.desc = featuredData.description;

      // Animation
      featuredPlant.classList.add('fade-transition');
      smallPlants.forEach(p => p.classList.add('fade-transition'));
      setTimeout(() => {
        featuredPlant.classList.remove('fade-transition');
        smallPlants.forEach(p => p.classList.remove('fade-transition'));
      }, 500);
    }

    function startAutoRotation() {
      isAutoRotating = true;
      pauseBtn.style.display = 'block';
      playBtn.style.display = 'none';
      autoRotationInterval = setInterval(rotatePlants, 3000);
    }

    function stopAutoRotation() {
      isAutoRotating = false;
      pauseBtn.style.display = 'none';
      playBtn.style.display = 'block';
      clearInterval(autoRotationInterval);
    }

    pauseBtn.addEventListener('click', stopAutoRotation);
    playBtn.addEventListener('click', startAutoRotation);

    // Manual swap
    smallPlants.forEach(plant => {
      plant.addEventListener('click', function () {
        if (isAutoRotating) clearInterval(autoRotationInterval);

        const oldFeatured = {
          name: featuredName.textContent,
          desc: featuredDesc.textContent,
          img: featuredImg.src
        };

        const newName = this.querySelector('.plant-small-name').textContent;
        const newImg = this.querySelector('img').src;
        const newDesc = this.dataset.desc;

        featuredName.textContent = newName;
        featuredImg.src = newImg;
        featuredDesc.textContent = newDesc;

        this.querySelector('.plant-small-name').textContent = oldFeatured.name;
        this.querySelector('img').src = oldFeatured.img;
        this.dataset.desc = oldFeatured.desc;

        featuredPlant.classList.add('fade-transition');
        this.classList.add('fade-transition');

        setTimeout(() => {
          featuredPlant.classList.remove('fade-transition');
          this.classList.remove('fade-transition');
        }, 500);

        if (isAutoRotating) autoRotationInterval = setInterval(rotatePlants, 3000);
      });

      // Hover styles
      plant.addEventListener('mouseenter', function () {
        this.style.transform = 'translateY(-5px)';
        this.style.boxShadow = '0 10px 20px rgba(0,0,0,0.1)';
      });
      plant.addEventListener('mouseleave', function () {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.05)';
      });
    });

    startAutoRotation();
  });
</script>
